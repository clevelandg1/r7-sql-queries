-- Pulls hostname, IP, OS info, agent ID, and check-in date for assets in the report scope
-- Added readable date formatting and additional context information

SELECT
  -- Asset Information
  da.ip_address AS "IP Address",
  da.host_name AS "Hostname",
  dos.description AS "Operating System",
  
  -- Agent ID Information
  COALESCE(
    -- Try different possible attribute names for Agent ID
    (SELECT attribute_value 
     FROM dim_mobile_asset_attribute 
     WHERE asset_id = da.asset_id 
     AND attribute_name = 'Agent ID'),
     
    (SELECT attribute_value 
     FROM dim_mobile_asset_attribute 
     WHERE asset_id = da.asset_id 
     AND attribute_name = 'agent.id'),
     
    (SELECT attribute_value 
     FROM dim_mobile_asset_attribute 
     WHERE asset_id = da.asset_id 
     AND attribute_name LIKE '%agent%id%'
     LIMIT 1),
     
    'No Agent ID'
  ) AS "Agent ID",
  
  -- Agent Version if available
  (SELECT attribute_value 
   FROM dim_mobile_asset_attribute 
   WHERE asset_id = da.asset_id 
   AND attribute_name = 'Agent Version') AS "Agent Version",
   
  -- Agent Last Check-in with readable date format
  COALESCE(
    -- First try specific agent check-in attribute
    (SELECT attribute_value 
     FROM dim_mobile_asset_attribute 
     WHERE asset_id = da.asset_id 
     AND attribute_name = 'Agent Last Check-in'),
     
    -- Look for other check-in related attributes
    (SELECT attribute_value 
     FROM dim_mobile_asset_attribute 
     WHERE asset_id = da.asset_id 
     AND attribute_name LIKE '%check%in%'
     LIMIT 1),
     
    -- Fall back to last assessment date if no agent check-in found
    CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
  ) AS "Last Check-in (Raw)",
  
  -- Format date for better readability if possible
  -- Will try to convert the raw value to a timestamp and format it
  -- If conversion fails, will show original value
  CASE 
    WHEN (
      COALESCE(
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name = 'Agent Last Check-in'),
         
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name LIKE '%check%in%'
         LIMIT 1),
         
        CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
      ) IS NOT NULL
      AND
      -- Try to detect if the value is a timestamp
      COALESCE(
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name = 'Agent Last Check-in'),
         
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name LIKE '%check%in%'
         LIMIT 1),
         
        CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
      ) ~ '^[0-9: -]+$'
    )
    THEN
      -- Format as readable date
      TO_CHAR(
        CAST(COALESCE(
          (SELECT attribute_value 
           FROM dim_mobile_asset_attribute 
           WHERE asset_id = da.asset_id 
           AND attribute_name = 'Agent Last Check-in'),
           
          (SELECT attribute_value 
           FROM dim_mobile_asset_attribute 
           WHERE asset_id = da.asset_id 
           AND attribute_name LIKE '%check%in%'
           LIMIT 1),
           
          CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
        ) AS TIMESTAMP), 
        'YYYY-MM-DD HH24:MI:SS'
      )
    ELSE
      -- Use raw value if not convertible to timestamp
      COALESCE(
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name = 'Agent Last Check-in'),
         
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name LIKE '%check%in%'
         LIMIT 1),
         
        CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
      )
  END AS "Last Check-in (Formatted)",
  
  -- Days since last check-in
  CASE 
    WHEN (
      COALESCE(
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name = 'Agent Last Check-in'),
         
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name LIKE '%check%in%'
         LIMIT 1),
         
        CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
      ) IS NOT NULL
      AND
      -- Try to detect if the value is a timestamp
      COALESCE(
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name = 'Agent Last Check-in'),
         
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name LIKE '%check%in%'
         LIMIT 1),
         
        CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
      ) ~ '^[0-9: -]+$'
    )
    THEN
      -- Calculate days since check-in
      EXTRACT(DAY FROM (CURRENT_TIMESTAMP - 
        CAST(COALESCE(
          (SELECT attribute_value 
           FROM dim_mobile_asset_attribute 
           WHERE asset_id = da.asset_id 
           AND attribute_name = 'Agent Last Check-in'),
           
          (SELECT attribute_value 
           FROM dim_mobile_asset_attribute 
           WHERE asset_id = da.asset_id 
           AND attribute_name LIKE '%check%in%'
           LIMIT 1),
           
          CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
        ) AS TIMESTAMP)
      ))
    ELSE
      NULL
  END AS "Days Since Check-in",
  
  -- Last scan time for reference
  da.last_assessed_for_vulnerabilities AS "Last Assessment"
  
FROM dim_asset da
LEFT JOIN dim_operating_system dos ON da.operating_system_id = dos.operating_system_id

-- No WHERE clause needed - the scope will be controlled by the report configuration

ORDER BY
  -- Order by days since check-in (stale agents first)
  CASE 
    WHEN (
      COALESCE(
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name = 'Agent Last Check-in'),
         
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name LIKE '%check%in%'
         LIMIT 1),
         
        CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
      ) IS NOT NULL
      AND
      -- Try to detect if the value is a timestamp
      COALESCE(
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name = 'Agent Last Check-in'),
         
        (SELECT attribute_value 
         FROM dim_mobile_asset_attribute 
         WHERE asset_id = da.asset_id 
         AND attribute_name LIKE '%check%in%'
         LIMIT 1),
         
        CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
      ) ~ '^[0-9: -]+$'
    )
    THEN
      EXTRACT(DAY FROM (CURRENT_TIMESTAMP - 
        CAST(COALESCE(
          (SELECT attribute_value 
           FROM dim_mobile_asset_attribute 
           WHERE asset_id = da.asset_id 
           AND attribute_name = 'Agent Last Check-in'),
           
          (SELECT attribute_value 
           FROM dim_mobile_asset_attribute 
           WHERE asset_id = da.asset_id 
           AND attribute_name LIKE '%check%in%'
           LIMIT 1),
           
          CAST(da.last_assessed_for_vulnerabilities AS VARCHAR)
        ) AS TIMESTAMP)
      ))
    ELSE
      999 -- Put assets with non-date check-in values at the end
  END DESC,
  da.host_name,
  da.ip_address;
